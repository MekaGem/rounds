<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Game</title>
    <link rel="stylesheet" type="text/css" href="style.css">
    <script src="https://code.createjs.com/createjs-2015.05.21.combined.js"></script>
    <script>
        var stage;
        var bg;

        var width = 0;
        var height = 0;
        var map = [];

        var time = new createjs.Text("", "14px Arial", "#FFFFFF");

        var players = {};

        var LEFT = 37;
        var UP = 38;
        var RIGHT = 39;
        var DOWN = 40;

        var dxy = {
            'LEFT': [-1, 0, 180],
            'UP': [0, 1, 90],
            'RIGHT': [1, 0, 0],
            'DOWN': [0, -1, 270]
        };

        var CELL_SIZE = 64;

        var host = "wss://HOST:9090/ws".replace("HOST", document.domain);
        var socket = new WebSocket(host);

        var server_timestamp_diff = 0;

        function getTimestamp() {
            return new Date().getTime()
        }

        var success_packets = 0;
        var fail_packets = 0;
        function updatePlayer(circle, content, timestamp) {
            var ts_diff = getTimestamp() - timestamp - server_timestamp_diff;
//            if (ts_diff < 0) {
//                server_timestamp_diff += ts_diff;
//                ts_diff = 0;
//            }
//
            console.log(ts_diff);
//
//            if (ts_diff > 100) {
//                fail_packets += 1;
//                return;
//            }
//            success_packets += 1;

            circle.x = content["x"] * CELL_SIZE;
            circle.y = CELL_SIZE * 5 - content["y"] * CELL_SIZE;
            circle.x_speed = 0;
            circle.y_speed = 0;

            var moving = content["moving"];

            if (moving) {
                circle.x_speed = CELL_SIZE * moving["x_speed"];
                circle.y_speed = CELL_SIZE * moving["y_speed"];

//                console.log(circle.x_speed);
//                console.log(circle.y_speed);
            }
        }

        function actPlayer(circle, delta) {
            circle.x += circle.x_speed * delta;
            circle.y -= circle.y_speed * delta;
        }

        if (socket) {
            socket.onopen = function() {
//                alert("connection opened....");
            };

            socket.onmessage = function(msg) {
                msg = JSON.parse(msg.data);

                var type = msg["type"];
                var content = msg["content"];
                var timestamp = msg["timestamp"];

                var circle;
                if (type == "PLAYER_UPDATE") {
                    if (content["id"] in players) {
                        circle = players[content["id"]];
                        updatePlayer(circle, content, timestamp);
                    } else {
                        circle = new createjs.Shape();
                        circle.graphics.beginFill("red").drawCircle(0, 0, CELL_SIZE * 0.4);
                        updatePlayer(circle, content, timestamp);

                        players[content["id"]] = circle;
                        stage.addChild(circle);
                    }
                } else if (type == "PLAYER_REMOVED") {
                    if (content["id"] in players) {
                        circle = players[content["id"]];
                        stage.removeChild(circle);
                    }
                } else if (type == 'SERVER_TIMESTAMP') {
//                    server_timestamp_diff = getTimestamp() - timestamp;
//                    console.log(server_timestamp_diff)
                } else if (type == 'LEVEL_INFO') {
                    width = content["width"];
                    height = content["height"];
                    createMap();
                    updateMap()
                }
            };

            socket.onclose = function() {
//                alert("connection closed....");
//                showServerResponse("The connection has been closed.");
            }

        } else {
            console.log("invalid socket");
        }

        var canvas;

        function onResizeHandler() {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
            updateMap();
        }

		function init() {
            canvas = document.getElementById("canvas");

            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;

			stage = new createjs.Stage("canvas");
            window.onresize = onResizeHandler;

            stage.addChild(time);

            createjs.Ticker.addEventListener("tick", tick);
            createjs.Ticker.framerate = 60;

            this.document.onkeydown = keyDown;
            this.document.onkeyup = keyUp;
		}

        function createMap() {
            for (var x = 0; x < width; ++x) {
                var row = [];
                for (var y = 0; y < height; ++y) {
                    var cell = new createjs.Shape();
                    cell.x = x * CELL_SIZE;
                    cell.y = y * CELL_SIZE;
                    cell.graphics.beginStroke("green").rect(0, 0, CELL_SIZE, CELL_SIZE);
                    row.push(cell);
                    stage.addChild(cell);
                }
                map.push(row);
            }
        }

        function updateMap() {
            var cx = (canvas.width - (width * CELL_SIZE)) / 2;
            var cy = (canvas.height - (height * CELL_SIZE)) / 2;
            console.log(cx, cy);
            console.log(map[0]);
            console.log(width, height);
            for (var x = 0; x < width; ++x) {
                for (var y = 0; y < height; ++y) {
                    var cell = map[x][y];
                    console.log(cell);
                    cell.x = cx + x * CELL_SIZE;
                    cell.y = cy + y * CELL_SIZE;
                }
            }
        }

        var keys = {};

        function keyDown(event) {
            keys[event.keyCode] = true;
        }

        function keyUp(event) {
            keys[event.keyCode] = false;
        }

        var direction = [0, 0];

        var timer = 0;
        function tick(event) {
            timer += event.delta;
            time.text = Math.floor(timer);

            var h_direction = 0;
            if (keys[LEFT]) h_direction = -1; // "LEFT";
            if (keys[RIGHT]) h_direction = 1; // "RIGHT";

            var v_direction = 0;
            if (keys[UP]) v_direction = 1; // "UP";
            if (keys[DOWN]) v_direction = -1; // "DOWN";

//            var new_direction = [h_direction, v_direction];
            if (h_direction != direction[0] || v_direction != direction[1]) {
                direction[0] = h_direction;
                direction[1] = v_direction;

                console.log("New direction");

                var message;
                if (direction == null) {
                    message = JSON.stringify({
                        "action": "STAND"
                    });
                } else {
                    message = JSON.stringify({
                        "action": "MOVE",
                        "direction": direction
                    });
                }
                console.log(message);
                socket.send(message);
            }

            for (var player_id in Object.keys(players)) {
                if (players.hasOwnProperty(player_id)) {
                    actPlayer(players[player_id], event.delta * 1 / 1000);
                }
            }

            stage.update()
        }
	</script>
</head>
<body onload="init();">
    <div id="wrapper" class="wrapperFullWindow">
        <canvas id="canvas" class="canvasFullWindow" width="1000" height="400"></canvas>
    </div>
</body>
</html>